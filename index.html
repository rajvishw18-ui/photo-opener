<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Google Drive Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google API Scripts -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <style>
        .loader { border-top-color: #3B82F6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
        <div class="text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>
            </div>
            <h1 class="text-3xl font-bold mb-2">Drive Gallery</h1>
            <p class="text-gray-500 mb-8">Connect your Google Drive to view & upload photos.</p>
            <button id="authorize_button" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold py-3 px-6 rounded-xl shadow-sm flex items-center gap-3 mx-auto transition-all">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                Sign In with Google
            </button>
            <p id="auth-error" class="text-red-500 mt-4 text-sm hidden">Error: Please check your API Keys.</p>
        </div>
    </div>

    <!-- MAIN APP (Hidden until logged in) -->
    <div id="app-content" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>
                    <span class="font-bold text-xl">Drive<span class="text-blue-600">Gallery</span></span>
                </div>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('file-input').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Upload Photo
                    </button>
                    <button id="signout_button" class="text-gray-500 hover:text-red-500 px-3 py-2">Sign Out</button>
                </div>
            </div>
        </header>

        <input type="file" id="file-input" class="hidden" accept="image/*" multiple>

        <!-- Status Bar -->
        <div id="status-bar" class="hidden max-w-7xl mx-auto px-4 py-2 mt-4">
            <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg flex items-center gap-2">
                <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-4 w-4"></div>
                <span id="status-text">Processing...</span>
            </div>
        </div>

        <!-- Gallery Grid -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <div id="gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Images will be injected here -->
            </div>
        </main>
    </div>

    <script>
        // TODO: REPLACE THESE WITH YOUR KEYS FROM GOOGLE CLOUD CONSOLE
        const CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; 
        const API_KEY = 'YOUR_API_KEY_HERE'; 

        // Discovery doc URL for APIs used by the quickstart
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        document.addEventListener('DOMContentLoaded', () => {
            if(CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
                alert("Please edit the HTML file and add your Google Client ID and API Key!");
            }
        });

        // 1. Load Google Libraries
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').onclick = handleAuthClick;
                document.getElementById('signout_button').onclick = handleSignoutClick;
            }
        }

        // 2. Authentication Logic
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                await listFiles();
            };

            if (gapi.client.getToken() === null) {
                // Prompt the user to select a Google Account and ask for consent to share their data
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // Skip display of account chooser and consent dialog for an existing session
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        // 3. File Operations
        async function listFiles() {
            updateStatus('Loading photos from Drive...', true);
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';

            try {
                // Search for images created by this app (drive.file scope limits visibility to only these)
                const response = await gapi.client.drive.files.list({
                    'pageSize': 20,
                    'fields': 'files(id, name, thumbnailLink, webContentLink)',
                    'q': "mimeType contains 'image/' and trashed = false"
                });
                
                const files = response.result.files;
                if (!files || files.length == 0) {
                    updateStatus('No photos found in Drive.', false);
                    return;
                }

                updateStatus('', false);

                for (const file of files) {
                    displayImage(file);
                }
            } catch (err) {
                console.error(err);
                updateStatus('Error loading files.', false);
            }
        }

        function displayImage(file) {
            const grid = document.getElementById('gallery-grid');
            
            // Note: Direct linking to Drive images is tricky. 
            // We use thumbnailLink for preview, but often it requires an auth token to view full size.
            // For a robust app, we would fetch the blob via API, but for simplicity here:
            
            const div = document.createElement('div');
            div.className = "bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-lg transition-all border border-gray-100";
            div.innerHTML = `
                <div class="aspect-[4/3] bg-gray-100 relative group">
                    <img src="${file.thumbnailLink}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                        <a href="${file.webContentLink}" target="_blank" class="bg-white text-gray-900 px-4 py-2 rounded-lg font-medium hover:bg-gray-100">
                            Download
                        </a>
                    </div>
                </div>
                <div class="p-3">
                    <p class="text-sm font-medium text-gray-700 truncate">${file.name}</p>
                </div>
            `;
            grid.prepend(div);
        }

        // 4. Upload Logic
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = [...e.target.files];
            if (files.length === 0) return;

            updateStatus(`Uploading ${files.length} items...`, true);

            for (const file of files) {
                await uploadFileToDrive(file);
            }

            updateStatus('Upload complete!', false);
            await listFiles(); // Refresh grid
        });

        async function uploadFileToDrive(file) {
            const metadata = {
                'name': file.name,
                'mimeType': file.type
            };

            const accessToken = gapi.client.getToken().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
                const data = await response.json();
                console.log('Uploaded:', data);
            } catch (error) {
                console.error('Upload error', error);
            }
        }

        function updateStatus(msg, show) {
            const el = document.getElementById('status-bar');
            const txt = document.getElementById('status-text');
            txt.innerText = msg;
            if (show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        // Start loading the scripts
        if (typeof gapi !== 'undefined') gapiLoaded();
        if (typeof google !== 'undefined') gisLoaded();
    </script>
</body>
</html>